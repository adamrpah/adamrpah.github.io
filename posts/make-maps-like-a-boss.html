<!DOCTYPE html>
<html prefix="
og: http://ogp.me/ns#
article: http://ogp.me/ns/article#
" lang="en">
    <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Make maps like a boss | NP Complete Heart</title>

                <link href="../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">

                <link rel="alternate" type="application/rss+xml" title="RSS" href="../rss.xml">

      <link rel="canonical" href="http://www.npcompleteheart.com/posts/make-maps-like-a-boss.html">




    
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js" type="text/javascript"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"] ],
        displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
        processEscapes: true
    },
    displayAlign: 'left', // Change this to 'center' to center equations.
    "HTML-CSS": {
        styles: {'.MathJax_Display': {"margin": 0}}
    }
});
</script>

        <!--[if lt IE 9]><script src="../assets/js/html5.js"></script><![endif]-->

    

    
    <meta name="author" content="Adam Pah">
        <meta property="og:site_name" content="NP Complete Heart">
    <meta property="og:title" content="Make maps like a boss">
    <meta property="og:url" content="http://www.npcompleteheart.com/posts/make-maps-like-a-boss.html">
    <meta property="og:description" content="When I worked on metabolism I didn't have any needs to plot data on an actual geographic area (although I always wished some form of coordinate system existed like that for my data). But in my switch ">
    <meta property="og:type" content="article">
    <meta property="article:published_time" content="2014-05-17T08:05:40-05:00">

    
    

</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="http://www.npcompleteheart.com/">

                <span id="blog-title">NP Complete Heart</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                                <li>
<a href="../rss.xml"><img src="../images/rss.png"></a>
                </li>
<li>
<a href="../pdf/curriculumvitae.pdf">Curriculum Vitae</a>
                </li>
<li>
<a href="../stories/publications/publications.html">Publications</a>

                
            </li>
</ul>

            <ul class="nav navbar-nav navbar-right">
                
            </ul>
        </div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav>

<!-- End of Menubar -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article">
        <header>
            <h1 class="p-name entry-title" itemprop="headline name"><a href="#" class="u-url">Make maps like a boss</a></h1>

        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">Adam Pah</span></p>
            <p class="dateline"><a href="#" rel="bookmark"><time class="published dt-published" datetime="2014-05-17T08:05:40-05:00" itemprop="datePublished" title="2014-05-17 08:05">2014-05-17 08:05</time></a></p>
            
        </div>
        
    </header>

    <div class="e-content entry-content" itemprop="articleBody text">
    <div tabindex="-1" id="notebook" class="border-box-sizing">
    <div class="container" id="notebook-container">

<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>
When I worked on metabolism I didn't have any needs to plot data on an actual geographic area (although I always wished some form of coordinate system existed like that for my data). But in my switch to working with health data I now have tons of spatial data. Moreover this spatial component is a fairly important effect on the patterns and behavior that I observe. 
</p>

<p>
So far I've been working with a GIS specialist (if you've looked at the maps in my small area estimation <a href="http://npcompleteheart.com/post/ever-wanted-to-estimate-small-area-effects-in-heal/">post</a> those are from him), but that's not an ideal situation when I only need a quick picture or to look at how data is distributed in space. When I needed to place data on a map previously I typically needed interactivity, so I would make a visualization with D3.js. But now I just need to make lots of maps quickly to just do exploratory analysis. Fortunately, I was looking for a solution right around the time the PyData conference was happening and I saw Rob Story's <a href="https://speakerdeck.com/wrobstory/up-and-down-the-python-data-and-web-visualization-stack">presentation on  </a><a href="http://nbviewer.ipython.org/gist/wrobstory/1eb8cb704a52d18b9ee8/Up%20and%20Down%20PyData%202014.ipynb">Up and Down the Python Data and Web Visualization Stack"</a>. This talk turned me onto Folium, especially after seeing it work with iPython notebook (which has become one of my favorite workflow tools).
<!-- TEASER_END -->
</p>

<p></p>
<h4>Making maps with Folium</h4>
<p>
...is pretty damn easy. If you follow the examples on the Gitub <a href="https://github.com/wrobstory/folium">page</a> with the example data you will be making maps in no time. Now comes the fun part, making maps with our own data!
</p>

<p></p>
<h5>Step 1. Obtain Shapefile data</h5>
<p>
To plot our own data we will need to get a GeoJSON or TopoJSON file that contains the path information about how to draw boundaries on the map. Unfortunately, the predominant file type for geographic data is a shapefile and geojson or topojson files are pretty scarce on the web. For the USA though we can easily get maps at all geographic resolutions from the <a href="http://www.census.gov/geo/maps-data/data/tiger-line.html">census/TIGER</a> website.
</p>

<p></p>
<h5>Step 2. Converting from shapefile-&gt;geojson-&gt;topojson</h5>
<p>
Since the open source world is rocking geojson or topojson files we just need to convert our new shapefile over. To do this we will need to install ogr2ogr (which is a part of the GDAL package) and topojson. On OSX this can be accomplished with homebrew and node.js very simply by:
<br>
</p>
<pre>
$ brew install gdal
$ brew install node
$ node install -g topojson
</pre>


<p>
For my needs I needed to plot data on Illinois zip codes so I downloaded the ZCTA (zip code tabulation area, not the exact same as zipcodes but close enough for me) file for Illinois. Proceeding with this file we first convert the shapefile to a geojson like so:
<br>
</p>
<pre>
$ ogr2ogr -f illinois.json tl_2010_17_zcta510.shp
&lt;/pre&gt;
&lt;br/&gt;
Next we convert the geojson to topojson. The only additional wrinkle from the geojson conversion is that we need to set the ID on each one of the areas (which is the same ID that we'll be binding to when we add data to the map). We can open up the geojson file and look at any of the "properties" entries to find the name of the needed key from the file. For the ZCTA file this key is "ZCTA5CE10". With that we convert the geojson to a topojson setting the ID and adding a zipcode property
&lt;br/&gt;
&lt;pre&gt;
$ topojson --id-property ZCTA5CE10 -p zipcode=ZCTA5CE10 illinois.json -o illinois_topo.json
</pre>


<p></p>
<h5>Step 3. Make one sweet map</h5>
This step is pretty simple. Take our new topojson file and the csv of data we have keyed on zipcode and throw it over the map like:
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">
In [1]:
</div>
<div class="inner_cell">
    <div class="input_area">
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">folium</span>
<span class="n">folium</span><span class="o">.</span><span class="n">initialize_notebook</span><span class="p">()</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">
<div class="prompt"></div>

<div class="output_html rendered_html output_subarea ">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css">
<style>
    .leaflet-popup-content {
        color: black !important;
    }

    .leaflet-container .leaflet-tile {
       margin: 0;
    }

    .leaflet-control-zoom-in {
        text-decoration: none !important;
    }

    .leaflet-control-zoom-out {
        text-decoration: none !important;
    }
</style>
</div>

</div>

<div class="output_area">
<div class="prompt"></div>

<div class="output_html rendered_html output_subarea ">
<script>

  var folium_event = new CustomEvent(
    "folium_libs_loaded",
    {bubbles: true, cancelable: true}
  );

  var load_folium_charts = function(){
    window.dispatchEvent(folium_event);
  };

 var load_folium_libs = function(){
    console.log('Loading all Folium libraries...')
    $.getScript("//cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.js", function(){
      $.getScript('//cdnjs.cloudflare.com/ajax/libs/leaflet-dvf/0.2/leaflet-dvf.markers.min.js', function(){
          if (window['vg'] === undefined){
            $.getScript("//cdnjs.cloudflare.com/ajax/libs/vega/1.4.3/vega.min.js", function(){
              load_folium_charts();
          });
        } else {
          load_folium_charts();
        }
      });
    });
  };

 if(typeof define === "function" && define.amd){
      var load_paths = {
        paths: {
          topojson:'https://cdnjs.cloudflare.com/ajax/libs/topojson/1.6.9/topojson.min.js',
          queue: 'https://cdnjs.cloudflare.com/ajax/libs/queue-async/1.0.7/queue.min.js',
          d3: 'https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js'
        }
      };
      var libs = ['d3', 'queue', 'topojson'];
      for (var i=0; i < libs.length; i++){
        lib = libs[i]
        if (window[lib] !== undefined){
          delete load_paths.paths[lib]
        };
      };
      if (Object.keys(load_paths.paths).length != 0){
        require.config(load_paths);
        require(["queue"], function(queue){
          window.queue = queue;
        });
        require(["d3"], function(d3){
            console.log('Loading from require.js...')
            window.d3 = d3;
            require(["topojson"], function(topojson){
                window.topojson = topojson;
                load_folium_libs();
            });
        });
      } else {
        load_folium_libs();
      }

 }else{
      console.log('Require.js not found!');
      throw "Require.js not found!"
 };

</script>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">
In [11]:
</div>
<div class="inner_cell">
    <div class="input_area">
<div class="highlight"><pre><span class="c">#Load the csv file using pandas</span>
<span class="n">chi_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">'cha_data.csv'</span><span class="p">)</span>

<span class="c">#Create the bins that we want using numpy linspace</span>
<span class="c">#My old implementation required a list, so we do it that way</span>
<span class="c">#To make it simple I just add a buffer onto the max</span>
<span class="n">bins</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s">'ashtma'</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">df</span><span class="p">[</span><span class="s">'ashtma'</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>

<span class="c">#We start the map with folium</span>
<span class="n">chi_map</span> <span class="o">=</span> <span class="n">folium</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="p">[</span><span class="mf">41.8819</span><span class="p">,</span> <span class="o">-</span><span class="mf">87.6278</span><span class="p">],</span> <span class="n">tiles</span><span class="o">=</span><span class="s">'Stamen Toner'</span><span class="p">,</span> <span class="n">zoom_start</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c">#We add in the geo json details</span>
<span class="n">chi_map</span><span class="o">.</span><span class="n">geo_json</span><span class="p">(</span><span class="n">geo_path</span> <span class="o">=</span> <span class="s">'topo_illinois.json'</span><span class="p">,</span> 
                 <span class="n">topojson</span> <span class="o">=</span> <span class="s">'objects.illinois'</span><span class="p">,</span>
                 <span class="n">data</span> <span class="o">=</span> <span class="n">chi_data</span><span class="p">,</span> 
                 <span class="n">threshold_scale</span> <span class="o">=</span> <span class="n">bins</span><span class="p">,</span>
                 <span class="n">data_out</span> <span class="o">=</span> <span class="s">'party.json'</span><span class="p">,</span>
                 <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s">'zipcode'</span><span class="p">,</span> <span class="s">'ashtma'</span><span class="p">],</span> 
                 <span class="n">key_on</span> <span class="o">=</span> <span class="s">'feature.id'</span><span class="p">,</span>
                 <span class="n">fill_opacity</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> 
                 <span class="n">line_opacity</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                 <span class="n">fill_color</span> <span class="o">=</span> <span class="s">'PuBuGn'</span><span class="p">,</span>
                 <span class="n">legend_name</span> <span class="o">=</span> <span class="s">'Number of Asthma Cases, 2006-2012'</span><span class="p">)</span>

<span class="c">#Write the map to an html file</span>
<span class="n">chi_map</span><span class="o">.</span><span class="n">create_map</span><span class="p">(</span><span class="s">'chi.html'</span><span class="p">)</span>

<span class="c">#And then we can say to display it in ipython notebook</span>
<span class="n">chi_map</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">
<div class="prompt output_prompt">
    Out[11]:</div>

<div class="output_html rendered_html output_subarea output_pyout">
<iframe class="folium-iframe" src="files/chi.html" style="width: 960px; height: 500px; border: none; margin-left: 75px;" scrolling="no"></iframe>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">
In []:
</div>
<div class="inner_cell">
    <div class="input_area">
<div class="highlight"><pre> 
</pre></div>

</div>
</div>
</div>

</div>
    </div>
  </div>

    </div>
    <aside class="postpromonav">
    <nav>
    
            <ul class="pager">
            <li class="previous">
                <a href="i-wish-i-knew-then-what-i-know-now-reproducible-methods-are-awesome.html" rel="prev" title="I wish I knew then what I know now (reproducible methods are awesome!)">Previous post</a>
            </li>
            <li class="next">
                <a href="calculating-a-gini-coefficient.html" rel="next" title="Calculating a Gini Coefficient">Next post</a>
            </li>
        </ul>

    </nav>
    </aside>
</article>

        </div>
        <!--End of body content-->

        <footer>
            Contents © 2015         <a href="mailto:adamrpah@gmail.com">Adam Pah</a> 
<br>
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">
<img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/80x15.png"></a>

            
        </footer>
    </div>
</div>

            <script src="../assets/js/all-nocdn.js"></script>
    
<!-- Social buttons -->
<div id="addthisbox" class="addthis_toolbox addthis_peekaboo_style addthis_default_style addthis_label_style addthis_32x32_style">
<a class="addthis_button_twitter"></a>
</div>
<!-- End of social buttons -->


    <script>$('a.image-reference:not(.islink)').colorbox({rel:"gal",maxWidth:"100%",maxHeight:"100%",scalePhotos:true});</script>
    <!-- fancy dates -->
    <script>
    moment.locale("");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script>
    <!-- end fancy dates -->

<script type="text/javascript">
  var _gaq = _gaq || [];
  var pluginUrl = 
    '//www.google-analytics.com/plugins/ga/inpage_linkid.js';
  _gaq.push(['_require', 'inpage_linkid', pluginUrl]);  
  _gaq.push(['_setAccount', 'UA-24774016-1']);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>


</body>
</html>
